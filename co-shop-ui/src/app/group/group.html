<div class="frame">
  <header class="header">
    <h1>Einkaufsübersicht</h1>
    <a class="add-button" [routerLink]="'add-item'">+</a>
  </header>

  <div class="items-container">
    <!-- Empty state -->
    @if (store.items().length === 0) {
      <div class="empty-state">
        <p>Keine Artikel gefunden.<br>Fügen Sie Ihren ersten Artikel hinzu!</p>
      </div>
    }

    <!-- Items list -->
    @for (item of store.items(); track item.id) {
      <div class="item-wrapper">
        <!-- Main item row -->
        <div class="item" (click)="toggleItemExpanded(item.id)">
          <div class="item-left">
            <div class="item-info">
              <div class="item-name">{{ item.name }}</div>
              @if (item.description) {
                <div class="item-description">{{ item.description }}</div>
              }
            </div>
            <div class="expand-indicator" [class.expanded]="isItemExpanded(item.id)">
              @if (item.requests.length > 0) {
                <span class="chevron">›</span>
              }
            </div>
          </div>
          <div class="item-actions">
            <button class="action-button commit-button" (click)="$event.stopPropagation(); openCommitModal(item)">
              <span class="commit-icon"></span>
            </button>
            <button class="action-button request-button" (click)="$event.stopPropagation(); openRequestModal(item)">
              <span class="star-icon"></span>
            </button>
            <div class="quantity-display">
              {{ store.getTotalCommitsForItem(item.id) }} / {{ store.getTotalRequestsForItem(item.id) }}
            </div>
          </div>
        </div>

        <!-- Collapsible requests section -->
        @if (isItemExpanded(item.id) && item.requests && item.requests.length > 0) {
          <div class="requests-section">
            @for (displayItem of store.getRequestAndCommitsCombined(item.id); track displayItem.memberId) {
              <div class="request-item">
                <div class="request-info">
                  <span class="request-member"> {{ store.getMemberNameById(displayItem.memberId) }} </span>
                  <span class="request-quantity"> {{ displayItem.qtyCommitted }}
                    / {{ displayItem.qtyRequested }} {{ item.unit }}</span>
                  @if (displayItem.forEveryone) {
                    <span class="for-everyone-tag">Für alle</span>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>

  <div class="center-div">
    <button routerLink="settlement" class="btn-settlement">Schulden anschauen</button>
  </div>
</div>

<!-- Commit Modal -->
@if (isCommitModalOpen && selectedItem) {
  <div class="modal-overlay" (click)="closeCommitModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Ich bringe mit</h2>
        <button class="close-button" (click)="closeCommitModal()">×</button>
      </div>

      <form class="commit-form" (ngSubmit)="confirmCommit()">
        <div class="form-field">
          <label>Artikel</label>
          <div class="input-wrapper">
            <input
              type="text"
              [value]="selectedItem.name"
              readonly
              class="form-input readonly"
            >
          </div>
        </div>

        <div class="form-field">
          <label>Anzahl</label>
          <div class="input-wrapper">
            <input
              type="number"
              name="commitAmount"
              [(ngModel)]="commitAmount"
              class="form-input"
              required
            >
            <span class="input-suffix">{{ selectedItem.unit }}</span>
          </div>
        </div>

        <div class="form-field">
          <label>Preis</label>
          <div class="input-wrapper">
            <input
              type="number"
              name="price"
              [(ngModel)]="price"
              class="form-input"
              required
            >
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeCommitModal()">
            Abbrechen
          </button>
          <button type="submit" class="btn btn-primary">
            {{ store.hasMemberCommit(selectedItem) ? 'Übernehmen' : 'Hinzufügen' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Request Modal -->
@if (isRequestModalOpen && selectedItem) {
  <div class="modal-overlay" (click)="closeRequestModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Artikel hinzufügen</h2>
        <button class="close-button" (click)="closeRequestModal()">×</button>
      </div>

      <form class="commit-form" (ngSubmit)="confirmRequest()">
        <div class="form-field">
          <label>Artikel</label>
          <div class="input-wrapper">
            <input
              type="text"
              [value]="selectedItem.name"
              readonly
              class="form-input readonly"
            >
          </div>
        </div>

        <div class="form-field">
          <label>Anzahl</label>
          <div class="input-wrapper">
            <input
              type="number"
              name="requestAmount"
              [(ngModel)]="requestAmount"
              class="form-input"
              required
            >
            <span class="input-suffix">{{ selectedItem.unit }}</span>
          </div>
        </div>

        <div class="form-field">
          <div class="checkbox-wrapper" (click)="forEveryone = !forEveryone">
            <div class="custom-checkbox" [class.checked]="forEveryone"></div>
            <span>Artikel ist für alle Gruppenmitglieder</span>
          </div>
          <input
            type="checkbox"
            name="forEveryone"
            [(ngModel)]="forEveryone"
            style="display: none;"
          >
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeRequestModal()">
            Abbrechen
          </button>
          <button type="submit" class="btn btn-primary">
            {{ store.hasMemberRequest(selectedItem) ? 'Übernehmen' : 'Hinzufügen' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}

